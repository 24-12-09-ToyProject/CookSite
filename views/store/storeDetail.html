{% extends "common/layout.html" %}

{% block extra_styles %}
<link rel="stylesheet" href="../../static/css/store/storeDetail.css">
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <section class="product-info">
        <div class="product-image">
            <img src="{{ details.product.PPODUCT_MAIN_IMG_URL }}" alt="{{ details.product.PRODUCT_NAME }}">
        </div>
        <div class="product-text">
            <div class="product-header">
                <span>{{ details.product.PRODUCT_NAME }}</span>
            </div>

            <div class="product-price" data-raw-price="{{ details.product.BASE_PRICE }}">
                <p><strong id="price-{{ details.product.product_no }}">{{ details.product.BASE_PRICE }}</strong> ì›</p>
            </div>
            <div class="shipping-info">
                <img src="../../static/img/store/van.png" alt="" class="shipping-icon">
                <p>ë°°ì†¡ <strong>3,500ì›</strong> (70,000ì› ì´ìƒ ë¬´ë£Œë°°ì†¡)</p>
            </div>
            <div class="reward-info">
                <img src="../../static/img/store/coin.png" alt="" class="reward-icon">
                <p>ì ë¦½ <strong><span id="reward-amount"></span></strong> ì› ì ë¦½ (êµ¬ë§¤ì•¡ì˜ 0.5% ì ë¦½)</p>
            </div>
            <section class="product-options">
                {% if details.options and details.options|length > 0 %}
                <form action="/store/order" method="POST" id="product-form">
                    <input type="hidden" name="productImg" value="{{ details.product.PPODUCT_MAIN_IMG_URL }}">
                    <input type="hidden" name="productNo" value="{{ details.product.PRODUCT_NO }}">
                    <input type="hidden" name="productName" value="{{ details.product.PRODUCT_NAME }}">
                    <input type="hidden" name="selectedOptionsData" id="selectedOptionsData">
                    <input type="hidden" name="totalPrice" id="totalPriceData">
                    <div class="option-select">
                        <label for="product-option"></label>
                        <select name="option" id="product-option">
                            <option value="" disabled selected>[ì„ íƒ] ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.</option>
                            {% for option in details.options %}
                            <option value="{{ option.OPTION_NO }}" data-name="{{ option.OPTION_NAME }}"
                                data-price="{{ option.OPTION_PRICE_DIFF }}" data-stock="{{ option.OPTION_STOCK }}">
                                {{ option.OPTION_NAME }} (ì¬ê³ ìˆ˜ëŸ‰ : {{ option.OPTION_STOCK }} ê°œ)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="selected-options-container"></div>
                    <p id="total-option">ì£¼ë¬¸ê¸ˆì•¡ <span id="total-price">0 ì›</span></p>
                    <button type="button" onclick="addCart()" class="add-to-cart">ì¥ë°”êµ¬ë‹ˆ</button>
                    <button type="submit" class="buy-now">ë°”ë¡œêµ¬ë§¤</button>
                </form>
                {% else %}
                <p>ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </section>
        </div>
    </section>
</div>
<div class="section-line"></div>
<div class="product-sub-image">
    <img src="{{ details.product.PPODUCT_SUB_IMG_URL }}" alt="{{ details.product.PRODUCT_NAME }}">
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll(".product-price").forEach(priceElement => {
            const rawPrice = priceElement.dataset.rawPrice;  // HTML ì†ì„±ì—ì„œ ê°€ê²© ê°€ì ¸ì˜¤ê¸°
            const formattedPrice = Number(rawPrice).toLocaleString(); // ì‰¼í‘œ ì¶”ê°€ ë³€í™˜
            priceElement.querySelector("strong").textContent = formattedPrice; // ë³€í™˜ëœ ê°’ ì ìš©
        });
    });
    const basePrice = {{ details.product.BASE_PRICE }};
    const rewardAmount = basePrice * 0.005;
    const productImg = document.querySelector("input[name='productImg']").value;
    const productName = document.querySelector("input[name='productName']").value;
    const productNo = document.querySelector("input[name='productNo']").value;

    document.getElementById('reward-amount').textContent = rewardAmount.toFixed(0);

    const selectedOptions = new Map(); // ì„ íƒëœ ì˜µì…˜ë“¤ì„ ì €ì¥í•  Map

    // ì˜µì…˜ ì„ íƒ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    document.getElementById('product-option').addEventListener('change', function () {

        const select = this;
        const selectedOption = select.options[select.selectedIndex];
        const optionNo = selectedOption.value; // ì˜µì…˜ ë²ˆí˜¸
        const stock = parseInt(selectedOption.getAttribute('data-stock'), 10);

        // âœ… ì¬ê³ ê°€ 0ì¸ ê²½ìš° ì„ íƒ ë¶ˆê°€
        if (stock === 0) {
            alert('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
            select.selectedIndex = 0; // ì„ íƒ ì´ˆê¸°í™”
            return;
        }

        // ì´ë¯¸ ì„ íƒëœ ì˜µì…˜ì¸ì§€ í™•ì¸
        if (selectedOptions.has(selectedOption.value)) {
            alert('ì´ë¯¸ ì„ íƒëœ ì˜µì…˜ì…ë‹ˆë‹¤.');
            select.selectedIndex = 0;
            return;
        }

        const optionData = {
            optionNo: selectedOption.value,
            name: selectedOption.getAttribute('data-name'),
            priceDiff: parseInt(selectedOption.getAttribute('data-price'), 10),
            stock: parseInt(selectedOption.getAttribute('data-stock'), 10),
            quantity: 1
        };

        // console.log("ì˜µì…˜ ë°ì´í„° ì¶”ê°€:", optionData); // ì˜µì…˜ ë°ì´í„° ë¡œê·¸ í™•ì¸

        addOptionToContainer(optionData);
        selectedOptions.set(optionData.optionNo, optionData);  // ì˜µì…˜ ì €ì¥

        // console.log("í˜„ì¬ selectedOptions:", selectedOptions); // ì„ íƒëœ ì˜µì…˜ ì „ì²´ ì¶œë ¥
        // console.log("ğŸ”¢ í˜„ì¬ selectedOptions size:", selectedOptions.size);
        // console.log("productImg =" + productImg);
        // console.log("productName = " + productName);

        updateTotalPrice();
        select.selectedIndex = 0; // ì„ íƒ ì´ˆê¸°í™”
    });



    // ì˜µì…˜ ì»¨í…Œì´ë„ˆì— ìƒˆë¡œìš´ ì˜µì…˜ ì¶”ê°€
    function addOptionToContainer(optionData) {
        const container = document.getElementById('selected-options-container');
        const optionDiv = document.createElement('div');
        optionDiv.className = 'selected-option-details';
        optionDiv.dataset.optionId = optionData.optionNo;

        const totalOptionPrice = basePrice + optionData.priceDiff;

        optionDiv.innerHTML = `
        <div class="option-info">
    <div class="option-header">
        <div class="option-name">${optionData.name}</div>
        <span class="option-delete">Ã—</span>
    </div>
    <div class="option-details">
        <div class="option-price">${totalOptionPrice.toLocaleString()}ì›</div>
        <div class="count-btn">
            <button type="button" class="decrease-btn">-</button>
            <span class="quantity">1</span>
            <button type="button" class="increase-btn">+</button>
        </div>
    </div>
    <span name="optionNo" value="${optionData.optionNo}">
    <input type="hidden" name="options[]" value="${optionData.id}">
    <input type="hidden" name="quantities[]" value="1">
</div>

        `;

        container.appendChild(optionDiv);

        // ìˆ˜ëŸ‰ ì¦ê°€ ë²„íŠ¼
        optionDiv.querySelector('.increase-btn').addEventListener('click', function () {
            const optionData = selectedOptions.get(optionDiv.dataset.optionId);
            if (optionData.quantity < optionData.stock) {
                optionData.quantity++;
                optionDiv.querySelector('.quantity').textContent = optionData.quantity;
                optionDiv.querySelector('input[name="quantities[]"]').value = optionData.quantity;
                updateOptionPrice(optionDiv, optionData);
                updateTotalPrice();
            } else {
                alert('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
            }
        });

        // ìˆ˜ëŸ‰ ê°ì†Œ ë²„íŠ¼
        optionDiv.querySelector('.decrease-btn').addEventListener('click', function () {
            const optionData = selectedOptions.get(optionDiv.dataset.optionId);
            if (optionData.quantity > 1) {
                optionData.quantity--;
                optionDiv.querySelector('.quantity').textContent = optionData.quantity;
                optionDiv.querySelector('input[name="quantities[]"]').value = optionData.quantity;
                updateOptionPrice(optionDiv, optionData);
                updateTotalPrice();
            }
        });

        // ì‚­ì œ ë²„íŠ¼
        optionDiv.querySelector('.option-delete').addEventListener('click', function () {
            selectedOptions.delete(optionDiv.dataset.optionId);
            optionDiv.remove();
            updateTotalPrice();
        });
    }

    // ê°œë³„ ì˜µì…˜ì˜ ê°€ê²© ì—…ë°ì´íŠ¸
    function updateOptionPrice(optionDiv, optionData) {
        const optionBasePrice = basePrice + optionData.priceDiff;
        optionDiv.querySelector('.option-price').textContent = `${optionBasePrice.toLocaleString()}ì›`;
    }

    // ì´ ê°€ê²© ì—…ë°ì´íŠ¸
    function updateTotalPrice() {
        let totalPrice = 0;
        selectedOptions.forEach(option => {
            totalPrice += (basePrice + option.priceDiff) * option.quantity;
        });
        document.getElementById('total-price').textContent = totalPrice.toLocaleString() + " ì›";
    }

    function addCart() {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        if (selectedOptions.size === 0) {
            alert("ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const selectedOptionsData = Array.from(selectedOptions.values()).map(option => ({
            productNo: productNo,
            productImg: productImg,
            productName: productName,
            optionName: option.name,
            optionNo: option.optionNo,
            quantity: option.quantity,
            price: (basePrice + option.priceDiff)
        }));

        // console.log("selectedOptionsData:", selectedOptionsData);

        const totalPrice = selectedOptionsData.reduce((sum, option) => sum + option.optionPrice, 0);


        // ì¥ë°”êµ¬ë‹ˆì— ì•„ì´í…œ ì¶”ê°€ ë¡œì§ ìˆ˜ì •
        selectedOptionsData.forEach(option => {
            const existingItemIndex = cart.findIndex(item =>
                item.productName === productName &&
                item.optionName === option.optionName
            );

            if (existingItemIndex !== -1) {
                // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì˜µì…˜ì´ë©´ ìˆ˜ëŸ‰ê³¼ ê°€ê²© ì—…ë°ì´íŠ¸
                cart[existingItemIndex].quantity += option.quantity;
                cart[existingItemIndex].price += option.price;
            } else {
                // ìƒˆë¡œìš´ ì˜µì…˜ì´ë©´ ì¶”ê°€
                cart.push(option);
            }
        });
        // ì¥ë°”êµ¬ë‹ˆì— ì €ì¥
        localStorage.setItem("cart", JSON.stringify(cart));
        const moveToCart = confirm("ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if (moveToCart) {
            window.location.href = "/store/cart"; // ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ë¡œ ì´ë™
        }

        // í¼ì— ë°ì´í„°ë¥¼ ì¶”ê°€
        updateFormData(selectedOptionsData);
    }

    // í¼ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ê°œì„ 
    function updateFormData(selectedOptionsData) {
        const selectedOptionsWithDetails = selectedOptionsData.map(option => ({
            productNo: productNo,
            productImg: productImg,
            productName: productName,
            optionName: option.optionName,
            optionNo: option.optionNo,
            quantity: option.quantity,
            optionPrice: option.optionPrice
        }));

        document.getElementById('selectedOptionsData').value = JSON.stringify(selectedOptionsWithDetails);
    }

    // ë°”ë¡œêµ¬ë§¤ ì‹œ í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ê°œì„ 
    document.getElementById('product-form').addEventListener('submit', function (e) {
        e.preventDefault();

        if (selectedOptions.size === 0) {
            alert('ìƒí’ˆ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        const selectedOptionsData = Array.from(selectedOptions.values()).map(option => {
            // console.log("Option data:", option); // ì˜µì…˜ ë°ì´í„° í™•ì¸
            // console.log("Price diff:", option.priceDiff); // priceDiff ê°’ í™•ì¸

            return {
                productNo: productNo,
                productImg: productImg,
                productName: productName,
                optionName: option.name,
                optionNo: option.optionNo,
                quantity: option.quantity,
                optionPrice: basePrice + option.priceDiff // option.priceDiff || 0 ì œê±°
            };
        });

        // console.log("Final selectedOptionsData:", selectedOptionsData); // ìµœì¢… ë°ì´í„° í™•ì¸


        // orderItemsì™€ totalPriceë¥¼ hidden í•„ë“œì— ì„¤ì •
        updateFormData(selectedOptionsData);

        // í¼ ì œì¶œ
        this.submit();
    });


</script>
{% endblock %}